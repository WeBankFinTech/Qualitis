[TOC]


# 一. 简介
&ensp;&ensp;Qualitis是一个数据质量管理系统，通过提供质量规则定义，动态任务配置，数据质量结果可视化，校验状态可监控的功能，用于监控生产中重要数据的质量情况。使用方式当前集中于UI方式，会逐步向命令行方式过渡。由此提供多使用角度的一整套统一的流程来定义和检测数据的质量并及时报告问题。


# 二. 特性
## 1. 可配置执行任务
&ensp;&ensp;Qualitis的校验任务以spark sql的查询操作为主，不同的用户校验任务的数据量，占用资源不尽相同，所以我们提供给每个用户修改默认资源配置的接口，包括常用的**队列选取**，**引擎的并发数**，**执行器实例数**等等，也可在每次执行前加入仅对当前任务会话有效的配置。

 ![1引擎配置](..\..\..\images\zh_CN\ch2\1引擎配置.png)

 ![2提交配置](..\..\..\images\zh_CN\ch2\2提交配置.png)


## 2. 可扩展主备服务
&ensp;&ensp;Qualitis各个服务之间是幂等的，可以通过同时起多个Qualitis服务，通过VIP对Qualitis服务进行负载均衡进行实现，通过Zookeeper保证多服务线程读写一致性。目前正式环境Qualitis部署有主备两个服务，来应对可能的服务不可用，性能响应问题。


## 3. 规范化指标管理
&ensp;&ensp;在大数据存储下，仅仅对表的校验进而返回的一系列数据源英文信息，很难让业务定位具体的产品，子系统，业务环节中的质量问题，所以我们引入指标的处理，关联具体规则，赋予校验结果真实的业务含义，帮助用户了解生产活动中的数据质量状态。


## 4. 单指标拓展到多指标校验
&ensp;&ensp;单指标校验，开放给用户编辑sql的SELECT部分，FROM部分，WHERE部分，而SELECT部分，限制用户选定一个聚合函数，最终产出一个维度的校验值。我们“单表校验”内置模板主要也是单指标，字段级的校验。

&ensp;&ensp;多指标校验，是指我们在一个规则中，SELECT部分可以计算出多个值，并一一对应指标管理中已创建的指标，分别计算指标值，而且整个sql交给用户编辑，解除单指标规则编辑中的限制，多个指标值计算处置后，分别进行结果校验，最终以多维度都通过校验，才算整个规则校验是通过的。


## 5. 规则模板库
&ensp;&ensp;Qualitis内置常用的单表规则模板，跨表规则模板，并可在“规则模板”功能新增和编辑自定义模板。

 ![3规则模板库](..\..\..\images\zh_CN\ch2\3规则模板库.png)

 ![4规则模板新增](..\..\..\images\zh_CN\ch2\4规则模板新增.png)

## 6. 校验结果分析
&ensp;&ensp;Qualitis可查看每个规则校验结果，并整合成质量分析报告表格，包含：规则名称，数据源信息，校验状态，历史值，任务时间等。

 ![5校验结果分析](..\..\..\images\zh_CN\ch2\5校验结果分析.png)


# 三. 命名规范
## 1. 项目和规则命名规范
- 项目：
  -- 英文名 (必填)：只支持英文名、数字和下划线，必须全局唯一，长度限制 ：64
  -- 中文名 (非必填，方便查询)：中文、英文、数字、下划线 ：128

- 规则：
  -- 英文名 (必填)：只支持英文名、数字和下划线，必须项目下，长度限制 ：128
  -- 中文名 (非必填，方便查询)：中文、英文、数字、下划线 ：128

## 2. 指标名的拼接规范
英文名：{子系统英文/二级产品英文/自定义英文}_{指标分类}_自定义英文_{指标值聚合频率}，长度限制：512
中文名：{子系统中文/二级产品中文/自定义英文}_{指标分类}_自定义英文_{指标值聚合频率}，长度限制：512
-- BDP或IT指标使用子系统
-- BDAP或业务指标使用二级产品
-- 非以上两类，支持自定义填写第一个字段

指标表需加个维度字段：SYSTEM/PRODUCT/CUSTOM

## 3. 异常数据存储表名称规范
&ensp;&ensp;Hive分区表名：{项目英文名}_{规则名}

&ensp;&ensp;分区名，通过用户指定分区格式，支持分区格式：{run_date}

# 四. 使用说明
## 1. 系统登录
&ensp;&ensp;输入ip:port即可访问UI。首页展示了当天任务的概览和及近日趋势变化图表。

 ![6登录](..\..\..\images\zh_CN\ch2\6登录.png)

 ![7首页](..\..\..\images\zh_CN\ch2\7首页.png)


## 2. 项目管理
&ensp;&ensp;项目，即规则的集合，可批量执行规则，授权细粒度权限等，拥有对应项目权限的用户，即拥有查看对应规则信息，任务信息的权限。创建项目：“我的项目 --- 新建项目 --- 点击保存”：


- 项目名称：项目的名称，不能重复。

- 项目介绍：对该项目的简单介绍。

- 项目标签：可以指定项目的标签，非必选。

 ![8项目管理](..\..\..\images\zh_CN\ch2\8项目管理.png)

&ensp;&ensp;项目列表展示了项目的基础信息，在项目详情页，具备一下功能：
- 项目记录，可定位项目操作历史，包括项目修改，规则增删与执行等。

 ![9项目记录](..\..\..\images\zh_CN\ch2\9项目记录.png)

- 项目授权

 ![10项目权限](..\..\..\images\zh_CN\ch2\10项目权限.png)

- 规则执行、管理

 ![11规则管理执行](..\..\..\images\zh_CN\ch2\11规则管理执行.png)


## 3. 规则管理
&ensp;&ensp;点击“添加规则”，选择规则类型（参照第二章，5小节），跳转至规则添加界面。规则的配置分为四部分：
1. 规则基础信息
   技术规则的名称，同一项目中不可重复。
2. 规则数据源
3. 规则校验方式
```
校验方式计算说明：
    月波动：将任务的运行结果和本条技术规则本月的运行结果的平均值y进行比较，如果(1-x)*y<=r<=(1+x)*y，任务通过校验，否则任务不通过校验。
    周波动：和月波动同理，计算的平均值是本周的平均值。
    日波动：和月波动，周波动同理，计算的平均值是本日的平均值。
    固定值：和一个固定值进行比较，比较的方式有等于，大于等等，如果比较选择比较方式是等于，那么如果r=x，那么任务通过校验。
    年环比：按照环比的计算：(本年平均值 - 去年平均值) / 去年平均值 = w %，然后w会与输入的阈值做不等于，等于，大于，小于等比较。
    半年环比：将计算周期设置为半年，计算方式同。
    季环比：将计算周期设置为一季度，计算方式同。
    月环比：将计算周期设置为月，计算方式同。
    周环比：将计算周期设置为周，计算方式同。
    日环比：将计算周期设置日，计算方式同。
    时环比：将计算周期设置时，计算方式同。
```
1. 规则执行参数

 ![12规则执行参数a](..\..\..\images\zh_CN\ch2\12规则执行参数a.png)

 ![13规则执行参数b](..\..\..\images\zh_CN\ch2\13规则执行参数b.png)

&ensp;&ensp;以上是空值检测的配置展示，其余规则模板的配置在“规则数据源”配置阶段略不相同，其余配置含义类似。为了方便用户在提交前设置规则执行参数，在“项目详情”规则列表右侧，提供编辑的快捷入口，仅供修改规则执行参数：

 ![14规则执行参数c](..\..\..\images\zh_CN\ch2\14规则执行参数c.png)

### 1）空值检测
- 语义：
  指定一个表中的某一个字段，检测出该字段为空的记录条数。

- 配置：
  首先选择空值检测模版。
  选择希望检测的集群，库名，表名，字段，并填入分区过滤条件，如下图所示：

 ![15空值检测](..\..\..\images\zh_CN\ch2\15空值检测.png)

### 2）主键检测
- 语义：
  指定一个表中的多个字段，检测这些字段的组合在该表中是否具有唯一性。

- 配置：
  首先选择主键检测模版。
  选择希望检测的集群，库名，表名，字段，并填入分区过滤条件，如下图所示：
   ![16主键检测](..\..\..\images\zh_CN\ch2\16主键检测.png)

### 3）表行数检测
- 语义：
  指定一个表，检测该表的行数是否达到预期。

- 配置：
  首先选择表行数检测模版。
  选择希望检测的集群，库名，表名，字段，并填入分区过滤条件，如下图所示：

 ![17表行数检测](..\..\..\images\zh_CN\ch2\17表行数检测.png)

### 4) 平均值检测 & 总和检测 & 最大值检测 & 最小值检测
- 语义：
  指定一个表中一个字段，检测该字段的平均值（总和，最大值，最小值类似）是否达到预期。

- 配置：
  首先选择平均值检测模版。
  选择希望检测的集群，库名，表名，字段，并填入分区过滤条件，如下图所示：

 ![18计算检测](..\..\..\images\zh_CN\ch2\18计算检测.png)

### 5）正则表达式检测 & 数值格式检测 & 身份证检测
- 语义：
  指定一个表中一个字段，找出该字段不满足给定正则表达式（数值格式默认正则表达式即```-?[0-9]+(\\.[0-9])?[0-9]*$```，身份证检测默认即```^[1-9][0-9]{5}(18|19|20)[0-9]{2}((0[1-9])|(1[0-2]))(([0-2][1-9])|10|20|30|31)[0-9]{3}[0-9Xx]$```，省略了表达式的录入，在此省略不表）的记录条数。

- 配置：
  首先选择正则表达式检测模版。
  选择希望检测的集群，库名，表名，字段，并填入分区过滤条件和正则表达式。如下图所示：

 ![19格式检测](..\..\..\images\zh_CN\ch2\19格式检测.png)

### 6）日期格式检测
- 语义：
  指定一个表中一个字段，找出该字段不满足选中日期格式的字段。

- 配置：
  首先选择日期格式检测模版。
  选择希望检测的集群，库名，表名，字段，并填入分区过滤条件，选中日期格式。如下图所示：

 ![20日期检测](..\..\..\images\zh_CN\ch2\20日期检测.png)

### 7）枚举值检测
- 语义：
  指定一个表中一个字段，找出该字段不在所给枚举值中的记录条数。

- 配置：
  首先选择枚举值检测模版。
  选择希望检测的集群，库名，表名，字段，并填入分区过滤条件和枚举值(逗号分隔)。如下图所示：

 ![21枚举检测](..\..\..\images\zh_CN\ch2\21枚举检测.png)

### 8）数值范围检测
- 语义：
  指定一个表中一个字段，找出该字段不在所给数值范围中的记录条数。

- 配置：
  首先选择数值范围检测模版。
  选择希望检测的集群，库名，表名，并填入分区过滤条件和数值范围。如下图所示：

 ![22范围检测](..\..\..\images\zh_CN\ch2\22范围检测.png)

### 9）逻辑类检测
- 语义：
  指定一个表，前置条件和后置条件，找到该表中满足该前置条件，但不满足后置条件的记录条数。

- 配置：
  首先选择逻辑类检测模版。
  选择希望检测的集群，库名，表名，字段，并填入分区过滤条件，前置条件和后置条件。如下图所示：

 ![23逻辑检测](..\..\..\images\zh_CN\ch2\23逻辑检测.png)

### 10）行数据重复检测
- 语义：
  指定一个表，指定参与行数据重复的字段（支持黑名单和白名单选择），系统会查询重复数据的最大重复数。

- 配置：
  首先选择行数据重复检测模版。
  选择希望检测的集群，库名，表名，黑名单或白名单字段，并填入分区过滤条件。如下图所示：

 ![24行数据重复检测](..\..\..\images\zh_CN\ch2\24行数据重复检测.png)

### 11）文件校验

 ![25文件校验](..\..\..\images\zh_CN\ch2\25文件校验.png)

- 语义：
  在特定情况下，hive表文件统计信息，如表大小，表文件数量，也是用户需要检测的重要指标，在Qualitis提供对文件大小和文件数量的校验。

- 配置：

 ![26文件校验](..\..\..\images\zh_CN\ch2\26文件校验.png)

### 12）跨表校验（准确性校验 & 跨表全量校验）

 ![27跨表校验](..\..\..\images\zh_CN\ch2\27跨表校验.png)

 ![28跨表校验](..\..\..\images\zh_CN\ch2\28跨表校验.png)

- 语义：
    跨表校验，主要针对于两张表在选定数据范围下，是否满足一致的校验。由名称可以看出校验粒度的区别。

- 配置：
    在数据源的过滤条件和映射关系中，加入了点选元素配置sql表达式的功能，有一定的使用门槛。
    - 跨表准确性检测可以选定两张表一一对应的一个或多个字段，判断查询结果是否一致；
       ![29跨表校验](..\..\..\images\zh_CN\ch2\29跨表校验.png)
       ![30跨表校验](..\..\..\images\zh_CN\ch2\30跨表校验.png)
       ![31跨表校验](..\..\..\images\zh_CN\ch2\31跨表校验.png)
    - 跨表全量检测，对两张表所有数据进行一致性校验，数据源配置与上同，任意选择一对字段相等作为映射关系即可；

### 13）跨表通用校验

 ![32跨表通用校验](..\..\..\images\zh_CN\ch2\32跨表通用校验.png)

- 语义：
  跨表通用校验，主要针对于A，B两张表在left join关联查询下，满足自定义过滤条件的数据数量的检测。

- 配置：

 ![33跨表通用校验](..\..\..\images\zh_CN\ch2\33跨表通用校验.png)

### 14）跨库比对

 ![34跨库校验](..\..\..\images\zh_CN\ch2\34跨库校验.png)

- 语义：
  跨库比对，是跨表全量校验规则批量创建的入口，库级一致性比对，待比较的表数量无法手工配置，故提供了更方便的跨库批量配置方式，可以直接将两个库的同名表，或者特定选择到白名单的非同名表（优先级最高），在黑名单规则（从同名表中过滤）作用下，批量创建。

- 配置：

 ![35跨库校验](..\..\..\images\zh_CN\ch2\35跨库校验.png)

### 15）单指标校验

 ![36单指标校验](..\..\..\images\zh_CN\ch2\36单指标校验.png)

- 语义：
  单指标校验，提供模块化的sql配置和常用聚合统计函数，可使用执行变量，对单一统计值进行指标关联与规则校验。

- 配置：

 ![37单指标校验](..\..\..\images\zh_CN\ch2\37单指标校验.png)

 ![38单指标校验](..\..\..\images\zh_CN\ch2\38单指标校验.png)

### 16）多指标校验
- 语义：
  多指标校验，在功能上完全包含单指标校验，可使用执行变量，在同一个sql中关联多个指标，完成多个校验结果的比较。

- 配置：

 ![39多指标校验](..\..\..\images\zh_CN\ch2\39多指标校验.png)

 ![40多指标校验](..\..\..\images\zh_CN\ch2\40多指标校验.png)

 ![41多指标校验](..\..\..\images\zh_CN\ch2\41多指标校验.png)

 ![42多指标校验](..\..\..\images\zh_CN\ch2\42多指标校验.png)

注意：

 ![43多指标校验](..\..\..\images\zh_CN\ch2\43多指标校验.png)

### 17）规则查询
&ensp;&ensp;规则数据源是用户关心的出发点，Qualitis支持从数据源定位所关联的规则，“选定数据源范围 --- 点击表名 --- 覆盖规则的字段”

 ![44规则查询](..\..\..\images\zh_CN\ch2\44规则查询.png)

 ![45规则查询](..\..\..\images\zh_CN\ch2\45规则查询.png)

 ![46规则查询](..\..\..\images\zh_CN\ch2\46规则查询.png)


## 4. 指标管理
&ensp;&ensp;仅仅对表数据校验进而返回的一系列数据源英文信息，很难让业务定位具体的子系统，业务环节中的质量问题，所以我们引入指标的处理，上文已经出现我们所用的指标，关联具体规则，赋予校验结果真实的业务含义，帮助用户了解生产活动中的数据质量状态。在系统中的入口如下：

 ![47指标管理](..\..\..\images\zh_CN\ch2\47指标管理.png)

  指标管理提供给用户维护指标的常用功能（创建，查询，导入，导出，关联规则，关联历史值，指标计算结果上传等），关联规则即可有指标查询使用该指标的规则，关联历史值即该指标关联的规则（包括已删除的规则）执行的历史结果记录；在知悉IMS系统监控指标的功能及应用前提下，Qualitis部署的规则关联指标的意义，主要是各部门在深度使用Qualitis之后，通过Qualitis反映的质量问题（Qualitis执行完成后向IMS进行上报的指标值）将关联各业务部门数据质量管控的KPI。Qualitis指标值上报分为两种指标计算结果上传的配置，在上文已经出现，基本可以见文知意：

&ensp;&ensp;指标的权限供分为三级，这和Qualitis系统使用者的三种角色是分不开的：
- 系统管理员创建的指标，全员可见，但只有系统管理员可编辑；
- 部门管理员创建的指标，系统管理员，部门管理员具备所有权限，跨部门不可见，同部门可使用，该部门普通用户不可编辑；
- 普通用户创建的指标，系统管理员，部门管理员，用户本人具备所有权限，不同的普通用户不可见。


## 5. 任务管理
&ensp;&ensp;规则创建完毕，接下来即可提交规则，规则提交可以从两个纬度执行，项目纬度和规则纬度。

 ![48任务管理](..\..\..\images\zh_CN\ch2\48任务管理.png)

 ![49任务管理](..\..\..\images\zh_CN\ch2\49任务管理.png)

  执行弹窗可对当前任务进行一系列配置：

&ensp;&ensp;任务提交成功后，在“任务查询”可看到任务提交的状态，日志，校验详情等：

 ![50任务查询](..\..\..\images\zh_CN\ch2\50任务查询.png)

 ![51任务日志](..\..\..\images\zh_CN\ch2\51任务日志.png)

 ![52任务状态](..\..\..\images\zh_CN\ch2\52任务状态.png)

&ensp;&ensp;注意，任务状态和备注可以快速反映数据问题，是首要需要关注的信息，在此做如下说明：

 ![53状态筛选条件](..\..\..\images\zh_CN\ch2\53状态筛选条件.png)

 ![54异常备注](..\..\..\images\zh_CN\ch2\54异常备注.png)

 ![55异常备注](..\..\..\images\zh_CN\ch2\55异常备注.png)


## 6. 数据质量分析
&ensp;&ensp;主要是将一段时期，选中状态的校验结果进行汇总并上传HDFS，数据源必选集群，数据库，可选表名（不选表名即收集数据库下所有执行过任务的表），数据源关联的校验结果会将不同的表写入同一个excel的不同sheet中，并以表名区分。

 ![56质量分析](..\..\..\images\zh_CN\ch2\56质量分析.png)

 ![57质量分析](..\..\..\images\zh_CN\ch2\57质量分析.png)

&ensp;&ensp;质量问题数据，也会被保存到异常数据中间表中，目前仍需切换至hive cli查看异常数据内容。

 ![58质量分析](..\..\..\images\zh_CN\ch2\58质量分析.png)


## 7. 在BDAP集群接入DSS工作流使用
  工作流数据校验是Qualitis数据质量校验重要的一个使用方式，依托于DSS工作流的设计，不仅可以对已有hive数据进行校验，还可以对各种ETL的中间表数据进行校验，要求对用户使用工作流有一定的熟悉。

  Qualitis同步DSS双中心设计，实现了开发中心与生产中心的部署，是为了将编辑校验规则与定时校验跑批分隔开，用户在DSS开发中心服务编辑规则，可进行多次执行测试与规则调整，期间的规则都是存储在Qualitis开发中心，确认无误，进行发布，会在Qualitis生产中心生成一模一样的规则，生产中心的规则即可被Schedulis定时调度执行，只需在Qualitis生产中心，或者Schedulis观察具体的校验结果即可。

&ensp;&ensp;使用方式主要是“拖拽 -- 双击节点进入内嵌规则编辑页面 -- 保存并执行 -- 发布”，发布之后至Schedulis进行调度操作。

 ![59工作流](..\..\..\images\zh_CN\ch2\59工作流.png)

 ![60工作流](..\..\..\images\zh_CN\ch2\60工作流.png)

